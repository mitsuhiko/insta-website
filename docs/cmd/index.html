<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Testing CLIs | Insta Snapshots</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    >
    <style>
  :root {
    /* Primary theme color */
    --primary-color: #86bbd8;
    /* Primary theme text color */
    --primary-text-color: #2f4858;
    /* Primary theme link color */
    --primary-link-color: #336699;
    /* Secondary color: the background body color */
    --secondary-color: #d0e3ee;
    --secondary-text-color: #303030;
    /* Light background */
    --light-color: #edf6fb;
    /* Highlight text color of table of content */
    --toc-highlight-text-color: #336699;
    --toc-highlight-background-color: var(--light-color);
  }
</style>

     <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
      href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,600;1,400;1,600&display=swap"
      rel="stylesheet"> 
    <link
      href="https://fonts.googleapis.com/css?family=Fira+Sans:300,400,500,600&display=swap"
      rel="stylesheet">
    <link rel="stylesheet" href="https://insta.rs/juice.css">
    
      
      
    
    <meta property="title" content="Testing CLIs">
    <meta property="og:title" content="Testing CLIs">
    <meta property="og:site_name" content="Insta Snapshots">
    <meta property="og:image" content="https://insta.rs/logo.png" />
    <meta name="twitter:site" content="@mitsuhiko">
    <meta name="twitter:title" content="Testing CLIs" />
    <meta name="description" content="Testing CLIs
There is an extension module to insta called insta-cmd
which allows to you to easily te…">
    <meta name="og:description" content="Testing CLIs
There is an extension module to insta called insta-cmd
which allows to you to easily te…">
    <meta name="twitter:description" content="Testing CLIs
There is an extension module to insta called insta-cmd
which allows to you to easily te…">
    <meta name="twitter:card" content="summary">
    
  </head>

  <body>
    
<header>
   
<a href="https:&#x2F;&#x2F;insta.rs&#x2F;">
  <div class="logo">
    <img src="https://insta.rs/icon.png" alt="logo" />
    Insta
  </div>
</a>

<nav>
  
  <a class="nav-item subtitle-text" href="&#x2F;docs&#x2F;">Docs</a>
  
  <a class="nav-item subtitle-text" href="&#x2F;changelog&#x2F;">Changelog</a>
  
  <a class="nav-item subtitle-text" href="&#x2F;similar&#x2F;">Similar</a>
  
  <a class="nav-item subtitle-text" href="https:&#x2F;&#x2F;github.com&#x2F;mitsuhiko&#x2F;insta">GitHub</a>
  
  <a class="nav-item subtitle-text" href="https:&#x2F;&#x2F;crates.io&#x2F;crates&#x2F;insta">Crate</a>
  
</nav>

</header>


    <main>
      
        
          
        
        
          
        
        
          
        
        <label for="toc-toggle" class="toggle-toc"><span>Toggle Navigation</span></label>
        <input type="checkbox" id="toc-toggle">
        <div class="toc">
          <div class="toc-sticky">
            
            
              <div class="toc-item">
                <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;">Overview</a>
              </div>
              
              <div class="toc-item">
                <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;quickstart&#x2F;">Getting Started</a>
              </div>
              
              <div class="toc-item">
                <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;snapshot-types&#x2F;">Snapshot Types</a>
              </div>
              
              <div class="toc-item">
                <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;serializers&#x2F;">Serializers</a>
              </div>
              
              <div class="toc-item">
                <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;snapshot-files&#x2F;">Snapshot Files</a>
              </div>
              
              <div class="toc-item">
                <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;redactions&#x2F;">Redactions</a>
              </div>
              
              <div class="toc-item">
                <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;filters&#x2F;">Filters</a>
              </div>
              
              <div class="toc-item">
                <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;advanced&#x2F;">Advanced Features</a>
              </div>
              
              <div class="toc-item">
                <a class="subtext current" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;cmd&#x2F;">Testing CLIs</a>
              </div>
              
              <div class="toc-item">
                <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;settings&#x2F;">Settings</a>
              </div>
              
              <div class="toc-item">
                <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;patterns&#x2F;">Patterns</a>
              </div>
              
              <div class="toc-item">
                <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;cli&#x2F;">Cargo Insta</a>
              </div>
              
              <div class="toc-item">
                <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;vscode&#x2F;">VS Code Extension</a>
              </div>
              
              
                
                <div class="toc-item">
                  <a class="subtext external" href="https:&#x2F;&#x2F;docs.rs&#x2F;insta">API Docs</a>
                </div>
                
              
              
            
            
              
              <hr>
              
              
                <div class="toc-item">
                  <a class="current" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;cmd&#x2F;#testing-clis">Testing CLIs</a>
                </div>
                
                  
                  <div class="toc-item">
                    <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;cmd&#x2F;#basics">Basics</a>
                  </div>
                  
                  
                  <div class="toc-item">
                    <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;cmd&#x2F;#passing-stdin">Passing Stdin</a>
                  </div>
                  
                  
                  <div class="toc-item">
                    <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;cmd&#x2F;#filtering">Filtering</a>
                  </div>
                  
                  
                  <div class="toc-item">
                    <a class="subtext" href="https:&#x2F;&#x2F;insta.rs&#x2F;docs&#x2F;cmd&#x2F;#examples">Examples</a>
                  </div>
                  
                  
                
              
            
          </div>
        </div>
      

      <div class="content text">
        
<h1 id="testing-clis">Testing CLIs</h1>
<p>There is an extension module to insta called <a href="https://github.com/mitsuhiko/insta-cmd"><code>insta-cmd</code></a>
which allows to you to easily test command line applications.</p>
<h2 id="basics">Basics</h2>
<p>The two most important APIs in <code>insta_cmd</code> are
<a href="https://docs.rs/insta-cmd/latest/insta_cmd/macro.assert_cmd_snapshot.html"><code>assert_cmd_snapshot</code></a>
and
<a href="https://docs.rs/insta-cmd/latest/insta_cmd/fn.get_cargo_bin.html"><code>get_cargo_bin</code></a>.  The
first is macro which lets you assert the output of a <a href="https://doc.rust-lang.org/std/process/struct.Command.html"><code>Command</code></a>.  The latter is a function that returns the path to a binary (the one from your crate).</p>
<p>In the most basic example you would end up with something like this:</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#72ab00;">use </span><span>std::process::Command;
</span><span style="color:#72ab00;">use </span><span>insta_cmd::{assert_cmd_snapshot, get_cargo_bin};
</span><span>
</span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">cli</span><span>() -&gt; Command {
</span><span>    Command::new(</span><span style="color:#b39f04;">get_cargo_bin</span><span>(</span><span style="color:#d07711;">&quot;my-executable&quot;</span><span>))
</span><span>}
</span><span>
</span><span>#[</span><span style="color:#5597d6;">test</span><span>]
</span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">test_version</span><span>() {
</span><span>    </span><span style="color:#a2a001;">assert_cmd_snapshot!</span><span>(</span><span style="color:#b39f04;">cli</span><span>().</span><span style="color:#b39f04;">arg</span><span>(</span><span style="color:#d07711;">&quot;--version&quot;</span><span>), </span><span style="color:#72ab00;">@</span><span style="color:#668f14;">r</span><span style="color:#d07711;">###&quot;
</span><span style="color:#d07711;">    success: true
</span><span style="color:#d07711;">    exit_code: 0
</span><span style="color:#d07711;">    ----- stdout -----
</span><span style="color:#d07711;">    my-executable 1.0.0
</span><span style="color:#d07711;">
</span><span style="color:#d07711;">    ----- stderr -----
</span><span style="color:#d07711;">    &quot;###</span><span>);
</span><span>}
</span></code></pre>
<h2 id="passing-stdin">Passing Stdin</h2>
<p>For when your application uses stdin, you can use the magic <code>pass_stdin</code> method that is
also available within the macro:</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#72ab00;">use </span><span>std::process::Command;
</span><span style="color:#72ab00;">use </span><span>insta_cmd::{assert_cmd_snapshot, get_cargo_bin};
</span><span>
</span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">cli</span><span>() -&gt; Command {
</span><span>    Command::new(</span><span style="color:#b39f04;">get_cargo_bin</span><span>(</span><span style="color:#d07711;">&quot;my-executable&quot;</span><span>))
</span><span>}
</span><span>
</span><span>#[</span><span style="color:#5597d6;">test</span><span>]
</span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">test_echo_back</span><span>() {
</span><span>    </span><span style="color:#a2a001;">assert_cmd_snapshot!</span><span>(</span><span style="color:#b39f04;">cli</span><span>().</span><span style="color:#b39f04;">arg</span><span>(</span><span style="color:#d07711;">&quot;echo-back&quot;</span><span>).</span><span style="color:#b39f04;">pass_stdin</span><span>(</span><span style="color:#d07711;">&quot;Hello World!&quot;</span><span>), </span><span style="color:#72ab00;">@</span><span style="color:#668f14;">r</span><span style="color:#d07711;">###&quot;
</span><span style="color:#d07711;">    success: true
</span><span style="color:#d07711;">    exit_code: 0
</span><span style="color:#d07711;">    ----- stdout -----
</span><span style="color:#d07711;">    Hello World!
</span><span style="color:#d07711;">
</span><span style="color:#d07711;">    ----- stderr -----
</span><span style="color:#d07711;">    &quot;###</span><span>);
</span><span>}
</span></code></pre>
<h2 id="filtering">Filtering</h2>
<p>The most important aspect when working with command line tools is to use the <code>filters</code>
feature to redact output.  This is because many command line tools use paths and other
things that make it otherwise hard to snapshot.  It's recommended to use a reusable macro
to normalize this.  Here an example of some filters:</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b39f04;">macro_rules! </span><span style="color:#c23f31;">apply_common_filters </span><span>{
</span><span>    {} </span><span style="color:#72ab00;">=&gt; </span><span>{
</span><span>        </span><span style="color:#668f14;">let mut</span><span> settings </span><span style="color:#72ab00;">= </span><span>insta::Settings::clone_current();
</span><span>        </span><span style="color:#7f8989;">// Macos Temp Folder
</span><span>        settings.</span><span style="color:#b39f04;">add_filter</span><span>(</span><span style="color:#668f14;">r</span><span style="color:#d07711;">&quot;/var/folders/\S+?/T/\S+&quot;</span><span>, </span><span style="color:#d07711;">&quot;[TEMP_FILE]&quot;</span><span>);
</span><span>        </span><span style="color:#7f8989;">// Linux Temp Folder
</span><span>        settings.</span><span style="color:#b39f04;">add_filter</span><span>(</span><span style="color:#668f14;">r</span><span style="color:#d07711;">&quot;/tmp/\.tmp\S+&quot;</span><span>, </span><span style="color:#d07711;">&quot;[TEMP_FILE]&quot;</span><span>);
</span><span>        </span><span style="color:#7f8989;">// Windows Temp folder
</span><span>        settings.</span><span style="color:#b39f04;">add_filter</span><span>(</span><span style="color:#668f14;">r</span><span style="color:#d07711;">&quot;\b[A-Z]:\\.*\\Local\\Temp\\\S+&quot;</span><span>, </span><span style="color:#d07711;">&quot;[TEMP_FILE]&quot;</span><span>);
</span><span>        </span><span style="color:#7f8989;">// Convert windows paths to Unix Paths.
</span><span>        settings.</span><span style="color:#b39f04;">add_filter</span><span>(</span><span style="color:#668f14;">r</span><span style="color:#d07711;">&quot;\\\\?([\w\d.])&quot;</span><span>, </span><span style="color:#d07711;">&quot;/$1&quot;</span><span>);
</span><span>        </span><span style="color:#668f14;">let</span><span> _bound </span><span style="color:#72ab00;">=</span><span> settings.</span><span style="color:#b39f04;">bind_to_scope</span><span>();
</span><span>    }
</span><span>}
</span></code></pre>
<p>And then you can use it as such:</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#5597d6;">test</span><span>]
</span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">test_basic</span><span>() {
</span><span>    </span><span style="color:#a2a001;">apply_common_filters!</span><span>();
</span><span>    </span><span style="color:#a2a001;">assert_cmd_snapshot!</span><span>(</span><span style="color:#b39f04;">cli</span><span>().</span><span style="color:#b39f04;">arg</span><span>(</span><span style="color:#d07711;">&quot;create-temp-file&quot;</span><span>).</span><span style="color:#b39f04;">arg</span><span>(</span><span style="color:#d07711;">&quot;--template=./foo&quot;</span><span>), </span><span style="color:#72ab00;">@</span><span style="color:#668f14;">r</span><span style="color:#d07711;">###&quot;
</span><span style="color:#d07711;">    success: true
</span><span style="color:#d07711;">    exit_code: 0
</span><span style="color:#d07711;">    ----- stdout -----
</span><span style="color:#d07711;">    Created temp file in [TEMP_FILE]
</span><span style="color:#d07711;">    Template file: ./foo
</span><span style="color:#d07711;">
</span><span style="color:#d07711;">    ----- stderr -----
</span><span style="color:#d07711;">    &quot;###</span><span>);
</span><span>}
</span></code></pre>
<h2 id="examples">Examples</h2>
<p>If you want to be inspired, have a look at the following projects for some ideas:</p>
<ul>
<li><code>rye</code>: <a href="https://github.com/astral-sh/rye/tree/main/rye/tests">rye tests</a></li>
<li><code>minijinja</code>: <a href="https://github.com/mitsuhiko/minijinja/blob/main/minijinja-cli/tests/test_basic.rs">minijinja-cli tests</a></li>
</ul>





        
          
        

        
          <div class="source-hint">
            Found an issue?
            You can
            <a href="https://github.com/mitsuhiko&#x2F;insta-website/edit/main/content/docs&#x2F;cmd.md">edit this page</a>
            on GitHub.
          </div>
        
      </div>
    </main>

    
<footer>
  <span>
    Created by <a href="https://lucumr.pocoo.org/">Armin Ronacher</a>
  </span>
  <span><a href="https://github.com/mitsuhiko/insta">Github</a></span>
  <span><a href="https://github.com/mitsuhiko/insta/issues">Issues</a></span>
  <span><a href="https://docs.rs/insta">API Documentation</a></span>
  <span><a href="/similar/">Similar</a></span>
  <span><a href="https://crates.io/crates/io">Crate</a></span>
</footer>

    <script>
      function highlightNav(heading) {
        let pathname = location.pathname;
        document.querySelectorAll(".toc a").forEach((item) => {
          item.classList.remove("active");
        });
        document
          .querySelector(".toc a[href$='" + pathname + "#" + heading + "']")
          .classList.add("active");
      }

      let currentHeading = "";
      window.onscroll = function () {
        let h = document.querySelectorAll("h1,h2,h3,h4,h5,h6");
        let elementArr = [];

        h.forEach((item) => {
          if (item.id !== "") {
            elementArr[item.id] = item.getBoundingClientRect().top;
          }
        });
        elementArr.sort();
        for (let key in elementArr) {
          if (!elementArr.hasOwnProperty(key)) {
            continue;
          }
          if (elementArr[key] > 0 && elementArr[key] < 300) {
            if (currentHeading !== key) {
              highlightNav(key);
              currentHeading = key;
            }
            break;
          }
        }
      };
    </script>
  </body>
</html>
